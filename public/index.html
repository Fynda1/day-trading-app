<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fynda Auto Trading BOT - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 50%, #2d3748 100%);
            color: white; padding: 10px; min-height: 100vh;
        }
        .container {
            max-width: 1600px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px; padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 2px solid rgba(79, 172, 254, 0.3);
        }
        .header-left { display: flex; flex-direction: column; align-items: flex-start; }
        .datetime-display {
            font-size: 18px; color: #ffffff; font-weight: bold;
            margin-top: 5px; letter-spacing: 0.5px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        h1 { font-size: 2.5em; color: #4facfe; text-shadow: 0 0 20px rgba(79, 172, 254, 0.5); }
        .connection-status {
            padding: 10px 20px; border-radius: 25px;
            font-size: 14px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
        }
        .connection-online { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 2px solid #22c55e; }
        .connection-offline { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 2px solid #ef4444; }
        .connection-demo { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 2px solid #fbbf24; }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        .left-panel { grid-column: 1; grid-row: 1 / 3; }
        .center-panel { grid-column: 2; grid-row: 1; }
        .right-panel { grid-column: 3; grid-row: 1; }
        .bottom-panel { grid-column: 2 / 4; grid-row: 2; }

        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 172, 254, 0.2);
            backdrop-filter: blur(5px);
        }

        .section-title {
            font-size: 1.4em; margin-bottom: 20px; color: #4facfe;
            border-bottom: 2px solid rgba(79, 172, 254, 0.3); padding-bottom: 10px;
            text-align: center; font-weight: 600;
        }

        /* Form Elements */
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; margin-bottom: 8px; font-weight: 600; 
            color: #cbd5e0; font-size: 14px;
        }

        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid rgba(79, 172, 254, 0.3);
            border-radius: 8px; background: rgba(255, 255, 255, 0.95);
            color: #000; font-size: 14px; font-weight: 600;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4facfe; outline: none;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase;
            letter-spacing: 0.5px; margin: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-buy { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-sell { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-cancel { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-flatten { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }

        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .button-row { display: flex; gap: 10px; margin-top: 10px; }

        /* Chart Container */
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px; padding: 20px;
            height: 400px; position: relative;
            border: 2px solid rgba(79, 172, 254, 0.3);
        }

        .chart-controls {
            display: flex; gap: 10px; margin-bottom: 15px;
            justify-content: center;
        }
        .chart-btn {
            padding: 8px 16px; border: 2px solid rgba(79, 172, 254, 0.5);
            background: rgba(79, 172, 254, 0.1); color: #4facfe;
            border-radius: 8px; cursor: pointer; font-size: 12px;
            font-weight: 600; transition: all 0.3s ease;
        }
        .chart-btn:hover, .chart-btn.active {
            background: #4facfe; color: white;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        }

        /* Watchlist */
        .watchlist-container { max-height: 400px; overflow-y: auto; }
        .watchlist-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px; padding: 12px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .watchlist-item:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: #4facfe; transform: translateX(5px);
        }

        .watchlist-ticker { font-weight: bold; font-size: 16px; color: #4facfe; }
        .watchlist-price { font-size: 14px; font-weight: bold; }
        .watchlist-change { font-size: 12px; }
        .watchlist-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            margin-left: 10px; animation: pulse 2s infinite;
        }
        .indicator-green { background: #22c55e; }
        .indicator-red { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        .price-neutral { color: #fbbf24; }

        /* Position Display */
        .position-display {
            background: rgba(79, 172, 254, 0.1);
            border-radius: 12px; padding: 15px;
            border: 2px solid rgba(79, 172, 254, 0.5);
            margin-bottom: 20px;
        }
        .position-stock { font-size: 24px; font-weight: bold; color: #4facfe; text-align: center; }
        .position-details {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 15px; margin-top: 15px; text-align: center;
        }
        .position-item { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; }
        .position-value { font-size: 18px; font-weight: bold; }
        .position-label { font-size: 12px; opacity: 0.8; margin-top: 5px; }

        /* Logs */
        .logs-panel {
            background: rgba(0, 0, 0, 0.4); border-radius: 10px;
            padding: 15px; height: 300px; overflow-y: auto;
            font-family: 'Courier New', monospace; font-size: 12px;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }
        .log-entry { margin-bottom: 5px; padding: 3px 0; }
        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        /* Volume Indicator */
        .volume-indicator {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; padding: 10px; margin-top: 10px;
            text-align: center;
        }
        .volume-bar {
            height: 6px; background: linear-gradient(90deg, #ef4444, #fbbf24, #22c55e);
            border-radius: 3px; margin-top: 5px;
            animation: volumePulse 2s infinite;
        }
        @keyframes volumePulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 280px 1fr 280px;
                gap: 10px;
            }
        }
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .left-panel, .center-panel, .right-panel, .bottom-panel {
                grid-column: 1;
                grid-row: auto;
            }
        }

        /* Authentication Modal */
        .auth-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .auth-panel {
            background: rgba(15, 20, 25, 0.95);
            border: 2px solid #4facfe; border-radius: 15px;
            padding: 30px; max-width: 500px; width: 90%;
            text-align: center; backdrop-filter: blur(10px);
        }
        .auth-title { font-size: 1.8em; margin-bottom: 20px; color: #4facfe; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Fynda Auto Trading BOT</h1>
                <div class="datetime-display" id="datetimeDisplay">Loading...</div>
            </div>
            <div class="connection-status connection-demo" id="connectionStatus" onclick="showAuthModal()">
                🟡 Demo Mode - Click to Connect Schwab
            </div>
        </div>

        <!-- Authentication Modal -->
        <div class="auth-modal" id="authModal">
            <div class="auth-panel">
                <div class="auth-title">Connect to Schwab thinkorswim</div>
                <div style="margin: 20px 0; text-align: left;">
                    <h3>Live Trading Mode</h3>
                    <p>Connect to your real Schwab account for live trading.</p>
                </div>
                <button class="btn btn-primary" onclick="startSchwabAuth()">Connect to Schwab Live</button>
                <div style="margin: 20px 0;">
                    <input type="text" id="authCode" placeholder="Enter authorization code..." style="display: none;">
                    <button class="btn btn-primary" id="completeAuthBtn" onclick="completeAuth()" style="display: none;">Complete Connection</button>
                </div>
                <div style="margin: 20px 0; text-align: left;">
                    <h3>Demo Mode</h3>
                    <p>Test safely with simulated data and trades.</p>
                </div>
                <button class="btn btn-cancel" onclick="enableDemoMode()">Continue in Demo Mode</button>
                <button class="btn btn-secondary" onclick="closeAuthModal()">Close</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left Panel: Trading Controls -->
            <div class="left-panel panel">
                <div class="section-title">Trading Controls</div>

                <div class="form-group">
                    <label for="customTicker">Stock Ticker:</label>
                    <input type="text" id="customTicker" placeholder="Enter ticker (e.g., AAPL)" style="text-transform: uppercase;">
                </div>

                <div class="form-group">
                    <label for="quantity">Shares:</label>
                    <input type="number" id="quantity" min="1" max="10000" value="100">
                </div>

                <div class="button-grid">
                    <button class="btn btn-buy" onclick="executeTrade('BUY')" id="buyBtn">BUY</button>
                    <button class="btn btn-sell" onclick="executeTrade('SELL')" id="sellBtn">SELL</button>
                </div>

                <div class="button-row">
                    <button class="btn btn-cancel" onclick="cancelAllOrders()">CANCEL</button>
                    <button class="btn btn-flatten" onclick="flattenPosition()">FLATTEN</button>
                </div>

                <div class="form-group">
                    <label for="stopLoss">Stop Loss ($):</label>
                    <input type="number" id="stopLoss" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="profitTarget">Profit Target ($):</label>
                    <input type="number" id="profitTarget" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="customStrategy">ThinkOrSwim Strategy:</label>
                    <textarea id="customStrategy" rows="6" placeholder="# Example ThinkOrSwim code:
# def rsi = RSI(length = 14);
# plot BuySignal = rsi < 30;
# plot SellSignal = rsi > 70;"></textarea>
                </div>

                <div class="button-row">
                    <button class="btn btn-primary" onclick="loadStrategy()">Load Strategy</button>
                    <button class="btn btn-secondary" onclick="testStrategy()">Test</button>
                </div>

                <div class="form-group">
                    <label for="scannerCode">Scanner Code:</label>
                    <textarea id="scannerCode" rows="4" placeholder="# Example scanner:
# close > sma(20)
# volume > average(volume, 50)
# rsi < 30"></textarea>
                </div>

                <button class="btn btn-primary" onclick="runScanner()" style="width: 100%;">Run Scanner</button>
            </div>

            <!-- Center Panel: Chart -->
            <div class="center-panel panel">
                <div class="section-title">Market Chart</div>

                <div class="chart-controls">
                    <button class="chart-btn active" onclick="changeTimeframe('1m', this)">1M</button>
                    <button class="chart-btn" onclick="changeTimeframe('5m', this)">5M</button>
                    <button class="chart-btn" onclick="changeTimeframe('15m', this)">15M</button>
                </div>

                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>

                <div class="volume-indicator">
                    <div style="font-size: 14px; font-weight: bold;">Volume: <span id="volumeDisplay">0</span></div>
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
            </div>

            <!-- Right Panel: Watchlist -->
            <div class="right-panel panel">
                <div class="section-title">Live Watchlist</div>

                <div class="form-group">
                    <input type="text" id="watchlistInput" placeholder="Add ticker (e.g., AAPL)">
                    <button class="btn btn-primary" onclick="addToWatchlist()" style="margin-top: 5px; width: 100%;">Add to Watchlist</button>
                </div>

                <div class="watchlist-container" id="watchlistContainer">
                    <!-- Watchlist items will be populated here -->
                </div>
            </div>

            <!-- Bottom Panel: Position & Logs -->
            <div class="bottom-panel panel">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="section-title">Current Position</div>
                        <div class="position-display">
                            <div class="position-stock" id="positionStock">No Position</div>
                            <div class="position-details">
                                <div class="position-item">
                                    <div class="position-value" id="positionShares">0</div>
                                    <div class="position-label">Shares</div>
                                </div>
                                <div class="position-item">
                                    <div class="position-value" id="positionAvgPrice">$0.00</div>
                                    <div class="position-label">Avg Price</div>
                                </div>
                                <div class="position-item">
                                    <div class="position-value pnl-positive" id="positionPnL">$0.00</div>
                                    <div class="position-label">P&L</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="section-title">
                            Event Logs
                            <button class="btn btn-secondary" onclick="toggleLogs()" style="float: right; padding: 5px 10px; font-size: 12px;">Toggle</button>
                        </div>
                        <div class="logs-panel" id="logsPanel">
                            <div id="logEntries"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Schwab API Configuration (from original code)
        class SchwabAPI {
            constructor() {
                this.clientId = '7GkeldTUPQ1zPrOHQRzR8BA3bNfnRGGI';
                this.clientSecret = '8bEOqZrayswy1DNG';
                this.redirectUri = 'https://day-trading-app-production.up.railway.app/callback.html';
                this.baseUrl = 'https://api.schwabapi.com';
                this.authUrl = 'https://api.schwabapi.com/v1/oauth/authorize';
                this.tokenUrl = 'https://api.schwabapi.com/v1/oauth/token';
                this.accessToken = localStorage.getItem('schwab_access_token');
                this.refreshToken = localStorage.getItem('schwab_refresh_token');
                this.tokenExpiry = localStorage.getItem('schwab_token_expiry');
                this.accountNumber = null;
            }

            getAuthorizationUrl() {
                const params = new URLSearchParams({
                    client_id: this.clientId,
                    redirect_uri: this.redirectUri,
                    response_type: 'code'
                });
                return `${this.authUrl}?${params.toString()}`;
            }

            async getTokens(authorizationCode) {
                try {
                    const response = await fetch(this.tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': `Basic ${btoa(this.clientId + ':' + this.clientSecret)}`
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: authorizationCode,
                            redirect_uri: this.redirectUri
                        })
                    });

                    if (!response.ok) throw new Error(`Token request failed: ${response.status}`);

                    const data = await response.json();
                    this.accessToken = data.access_token;
                    this.refreshToken = data.refresh_token;
                    this.tokenExpiry = Date.now() + (data.expires_in * 1000);
                    
                    localStorage.setItem('schwab_access_token', this.accessToken);
                    localStorage.setItem('schwab_refresh_token', this.refreshToken);
                    localStorage.setItem('schwab_token_expiry', this.tokenExpiry);
                    
                    return true;
                } catch (error) {
                    console.error('Failed to get tokens:', error);
                    return false;
                }
            }

            async makeRequest(endpoint, options = {}) {
                if (!this.accessToken) throw new Error('No access token. Please authenticate first.');
                
                const url = `${this.baseUrl}${endpoint}`;
                const requestOptions = {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                };

                const response = await fetch(url, requestOptions);
                if (!response.ok) throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                return response.json();
            }

            async getQuote(symbol) {
                return this.makeRequest(`/marketdata/v1/quotes?symbols=${symbol}`);
            }

            async placeOrder(orderData) {
                if (!this.accountNumber) await this.getAccounts();
                return this.makeRequest(`/trader/v1/accounts/${this.accountNumber}/orders`, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
            }

            isAuthenticated() {
                return !!this.accessToken && Date.now() < this.tokenExpiry;
            }
        }

        // Global Variables
        let schwabAPI = new SchwabAPI();
        let currentTicker = '';
        let currentTimeframe = '1m';
        let isLiveMode = false;
        let chart = null;
        let watchlist = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA'];
        let currentPosition = { symbol: '', shares: 0, avgPrice: 0, pnL: 0 };

        // Mock data for demo mode
        const mockData = {
            'AAPL': { price: 185.50, change: 2.15, volume: 55420000 },
            'MSFT': { price: 415.75, change: 3.45, volume: 22100000 },
            'GOOGL': { price: 2875.20, change: -15.80, volume: 1250000 },
            'AMZN': { price: 3125.90, change: 45.20, volume: 3200000 },
            'TSLA': { price: 245.30, change: -8.90, volume: 89500000 }
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Enhanced Fynda Auto Trading BOT initialized');
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            if (schwabAPI.isAuthenticated()) {
                enableLiveMode();
            } else {
                enableDemoMode();
            }
            
            initializeChart();
            loadWatchlist();
            startDataUpdates();
        });

        // Date/Time Updates
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            };
            document.getElementById('datetimeDisplay').textContent = now.toLocaleDateString('en-US', options);
        }

        // Authentication Functions
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function startSchwabAuth() {
            try {
                const authUrl = schwabAPI.getAuthorizationUrl();
                window.open(authUrl, '_blank', 'width=600,height=700');
                document.getElementById('authCode').style.display = 'block';
                document.getElementById('completeAuthBtn').style.display = 'block';
                addLog('🔗 Authorization window opened', 'info');
            } catch (error) {
                addLog(`❌ Failed to start auth: ${error.message}`, 'error');
            }
        }

        async function completeAuth() {
            const authCode = document.getElementById('authCode').value.trim();
            if (!authCode) {
                alert('Please enter the authorization code');
                return;
            }

            try {
                const success = await schwabAPI.getTokens(authCode);
                if (success) {
                    enableLiveMode();
                    closeAuthModal();
                    addLog('🎉 Successfully connected to Schwab Live Trading!', 'success');
                } else {
                    throw new Error('Failed to get tokens');
                }
            } catch (error) {
                addLog(`❌ Authentication failed: ${error.message}`, 'error');
                alert(`Authentication failed: ${error.message}`);
            }
        }

        function enableLiveMode() {
            isLiveMode = true;
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = '🟢 LIVE - Schwab Connected';
            statusEl.className = 'connection-status connection-online';
            addLog('🔴 LIVE TRADING MODE ACTIVE', 'warning');
        }

        function enableDemoMode() {
            isLiveMode = false;
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = '🟡 Demo Mode';
            statusEl.className = 'connection-status connection-demo';
            closeAuthModal();
            addLog('🎮 Demo mode activated', 'info');
        }

        // Trading Functions
        async function executeTrade(action) {
            const ticker = document.getElementById('customTicker').value.toUpperCase().trim();
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!ticker) {
                alert('Please enter a stock ticker');
                addLog('❌ Trade failed: No ticker entered', 'error');
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }

            if (isLiveMode) {
                const confirmed = confirm(`🚨 LIVE TRADE CONFIRMATION 🚨\n\n${action} ${quantity} shares of ${ticker}\n\nThis will use REAL MONEY!\n\nAre you sure?`);
                if (!confirmed) return;

                try {
                    const orderData = {
                        orderType: 'MARKET',
                        session: 'NORMAL',
                        duration: 'DAY',
                        orderStrategyType: 'SINGLE',
                        orderLegCollection: [{
                            instruction: action,
                            quantity: quantity,
                            instrument: { symbol: ticker, assetType: 'EQUITY' }
                        }]
                    };

                    addLog(`🔥 PLACING LIVE ORDER: ${action} ${quantity} ${ticker}`, 'warning');
                    const result = await schwabAPI.placeOrder(orderData);
                    
                    if (result) {
                        addLog(`✅ LIVE ORDER PLACED: ${action} ${quantity} shares of ${ticker}`, 'success');
                        updatePosition(ticker, action === 'BUY' ? quantity : -quantity, getCurrentPrice(ticker));
                    }
                } catch (error) {
                    addLog(`❌ LIVE TRADE FAILED: ${error.message}`, 'error');
                    alert(`Live trade failed: ${error.message}`);
                }
            } else {
                // Demo trading
                const price = getCurrentPrice(ticker);
                const shares = action === 'BUY' ? quantity : -quantity;
                updatePosition(ticker, shares, price);
                addLog(`💰 DEMO: ${action} ${quantity} shares of ${ticker} at ${price.toFixed(2)}`, 'success');
                showTradeNotification(action, quantity, ticker, price);
            }
        }

        function cancelAllOrders() {
            if (isLiveMode) {
                if (confirm('🚨 Cancel ALL live orders?')) {
                    addLog('🚫 LIVE: Attempting to cancel all orders', 'warning');
                    alert('Live order cancellation feature coming soon!');
                }
            } else {
                addLog('🚫 DEMO: All orders cancelled', 'warning');
            }
        }

        function flattenPosition() {
            if (currentPosition.shares === 0) {
                alert('No position to flatten');
                return;
            }

            const action = currentPosition.shares > 0 ? 'SELL' : 'BUY';
            const quantity = Math.abs(currentPosition.shares);
            
            if (isLiveMode) {
                if (confirm(`🚨 FLATTEN POSITION: ${action} ${quantity} shares of ${currentPosition.symbol}?`)) {
                    addLog(`🔄 LIVE: Flattening position - ${action} ${quantity} ${currentPosition.symbol}`, 'warning');
                    // Execute the flatten trade
                    document.getElementById('customTicker').value = currentPosition.symbol;
                    document.getElementById('quantity').value = quantity;
                    executeTrade(action);
                }
            } else {
                const price = getCurrentPrice(currentPosition.symbol);
                updatePosition(currentPosition.symbol, -currentPosition.shares, price);
                addLog(`🔄 DEMO: Position flattened - ${action} ${quantity} ${currentPosition.symbol}`, 'info');
            }
        }

        // Position Management
        function updatePosition(symbol, shares, price) {
            if (currentPosition.symbol === '' || currentPosition.symbol === symbol) {
                currentPosition.symbol = symbol;
                
                // Calculate new average price
                const totalShares = currentPosition.shares + shares;
                if (totalShares === 0) {
                    currentPosition = { symbol: '', shares: 0, avgPrice: 0, pnL: 0 };
                } else {
                    const totalValue = (currentPosition.shares * currentPosition.avgPrice) + (shares * price);
                    currentPosition.avgPrice = totalValue / totalShares;
                    currentPosition.shares = totalShares;
                }
            }
            
            updatePositionDisplay();
            updateChart();
        }

        function updatePositionDisplay() {
            const posStockEl = document.getElementById('positionStock');
            const posSharesEl = document.getElementById('positionShares');
            const posAvgPriceEl = document.getElementById('positionAvgPrice');
            const posPnLEl = document.getElementById('positionPnL');

            if (currentPosition.shares === 0) {
                posStockEl.textContent = 'No Position';
                posSharesEl.textContent = '0';
                posAvgPriceEl.textContent = '$0.00';
                posPnLEl.textContent = '$0.00';
                posPnLEl.className = 'position-value';
            } else {
                const currentPrice = getCurrentPrice(currentPosition.symbol);
                const pnl = (currentPrice - currentPosition.avgPrice) * currentPosition.shares;
                
                posStockEl.textContent = currentPosition.symbol;
                posSharesEl.textContent = currentPosition.shares.toString();
                posAvgPriceEl.textContent = `${currentPosition.avgPrice.toFixed(2)}`;
                posPnLEl.textContent = `${pnl.toFixed(2)}`;
                posPnLEl.className = `position-value ${pnl >= 0 ? 'price-up' : 'price-down'}`;
                
                currentPosition.pnL = pnl;
            }
        }

        // Chart Functions
        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cbd5e0' }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cbd5e0' }
                        }
                    },
                    elements: {
                        point: { radius: 0, hoverRadius: 5 }
                    }
                }
            });
        }

        function updateChart() {
            if (!chart || !currentTicker) return;

            const ticker = currentTicker || (currentPosition.symbol || 'AAPL');
            const price = getCurrentPrice(ticker);
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();

            // Add new data point
            chart.data.labels.push(timeLabel);
            chart.data.datasets[0].data.push(price);

            // Keep only last 50 data points
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update('none');
        }

        function changeTimeframe(timeframe, buttonElement) {
            currentTimeframe = timeframe;
            
            // Update active button
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            buttonElement.classList.add('active');
            
            addLog(`📊 Chart timeframe changed to ${timeframe}`, 'info');
        }

        // Price Data Functions
        function getCurrentPrice(symbol) {
            if (!symbol) return 0;
            
            if (mockData[symbol]) {
                // Add some randomness to simulate real price movement
                const basePrice = mockData[symbol].price;
                const variation = (Math.random() - 0.5) * 2; // ±1 dollar variation
                return basePrice + variation;
            }
            
            // Random price for unknown symbols
            return Math.random() * 200 + 50;
        }

        function getCurrentVolume(symbol) {
            if (!symbol) return 0;
            return mockData[symbol]?.volume || Math.floor(Math.random() * 10000000);
        }

        // Watchlist Functions
        function addToWatchlist() {
            const input = document.getElementById('watchlistInput');
            const symbol = input.value.toUpperCase().trim();
            
            if (!symbol) {
                alert('Please enter a ticker symbol');
                return;
            }
            
            if (watchlist.includes(symbol)) {
                alert(`${symbol} is already in the watchlist`);
                return;
            }
            
            watchlist.push(symbol);
            input.value = '';
            updateWatchlist();
            addLog(`📋 Added ${symbol} to watchlist`, 'info');
        }

        function loadWatchlist() {
            updateWatchlist();
        }

        function updateWatchlist() {
            const container = document.getElementById('watchlistContainer');
            container.innerHTML = '';
            
            watchlist.forEach(symbol => {
                const price = getCurrentPrice(symbol);
                const change = mockData[symbol]?.change || (Math.random() - 0.5) * 10;
                const changeClass = change >= 0 ? 'price-up' : 'price-down';
                
                // Simple strategy signal (random for demo)
                const signal = Math.random() > 0.5 ? 'green' : 'red';
                
                const item = document.createElement('div');
                item.className = 'watchlist-item';
                item.onclick = () => selectFromWatchlist(symbol);
                
                item.innerHTML = `
                    <div>
                        <div class="watchlist-ticker">${symbol}</div>
                        <div class="watchlist-price">${price.toFixed(2)}</div>
                        <div class="watchlist-change ${changeClass}">${change >= 0 ? '+' : ''}${change.toFixed(2)}</div>
                    </div>
                    <div class="watchlist-indicator indicator-${signal}"></div>
                `;
                
                container.appendChild(item);
            });
        }

        function selectFromWatchlist(symbol) {
            currentTicker = symbol;
            document.getElementById('customTicker').value = symbol;
            updateChart();
            addLog(`📊 Selected ${symbol} from watchlist`, 'info');
        }

        // Strategy Functions
        function loadStrategy() {
            const strategy = document.getElementById('customStrategy').value.trim();
            if (!strategy) {
                alert('Please enter a strategy first');
                return;
            }
            addLog('📝 Custom strategy loaded', 'info');
            alert('Strategy loaded successfully!\n\nThis will be applied to signal generation.');
        }

        function testStrategy() {
            const strategy = document.getElementById('customStrategy').value.trim();
            if (!strategy) {
                alert('Please enter a strategy first');
                return;
            }
            
            addLog('🧪 Testing strategy...', 'info');
            
            // Simulate strategy test
            setTimeout(() => {
                const results = {
                    syntaxCheck: true,
                    backtestReturn: (Math.random() * 20 - 10).toFixed(2),
                    winRate: (Math.random() * 40 + 50).toFixed(1),
                    sharpeRatio: (Math.random() * 2).toFixed(2)
                };
                
                addLog(`✅ Strategy test complete: ${results.backtestReturn}% return, ${results.winRate}% win rate`, 'success');
                alert(`Strategy Test Results:\n\n✅ Syntax Check: Passed\n📈 Backtest Return: ${results.backtestReturn}%\n🎯 Win Rate: ${results.winRate}%\n📊 Sharpe Ratio: ${results.sharpeRatio}`);
            }, 2000);
        }

        // Scanner Functions
        function runScanner() {
            const scannerCode = document.getElementById('scannerCode').value.trim();
            if (!scannerCode) {
                alert('Please enter scanner criteria first');
                return;
            }
            
            addLog('🔍 Running market scanner...', 'info');
            
            // Simulate scanner results
            setTimeout(() => {
                const results = ['AAPL', 'MSFT', 'NVDA'].filter(() => Math.random() > 0.5);
                addLog(`🎯 Scanner found ${results.length} matches: ${results.join(', ')}`, 'success');
                
                // Add results to watchlist
                results.forEach(symbol => {
                    if (!watchlist.includes(symbol)) {
                        watchlist.push(symbol);
                    }
                });
                updateWatchlist();
            }, 3000);
        }

        // Utility Functions
        function showTradeNotification(action, quantity, symbol, price) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: ${action === 'BUY' ? '#10b981' : '#ef4444'};
                color: white; padding: 15px 20px; border-radius: 10px;
                font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
            `;
            notification.innerHTML = `
                ✅ ${action} Order Executed<br>
                ${quantity} shares of ${symbol} @ ${price.toFixed(2)}
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;

            const logContainer = document.getElementById('logEntries');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 log entries
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function toggleLogs() {
            const logsPanel = document.getElementById('logsPanel');
            const isVisible = logsPanel.style.display !== 'none';
            logsPanel.style.display = isVisible ? 'none' : 'block';
        }

        // Data Updates
        function startDataUpdates() {
            // Update prices every 3 seconds
            setInterval(() => {
                if (currentTicker || currentPosition.symbol) {
                    updateChart();
                    updatePositionDisplay();
                }
                updateWatchlist();
                updateVolumeDisplay();
            }, 3000);
            
            // Update volume display
            setInterval(() => {
                updateVolumeDisplay();
            }, 5000);
        }

        function updateVolumeDisplay() {
            const symbol = currentTicker || currentPosition.symbol || 'AAPL';
            const volume = getCurrentVolume(symbol);
            const volumeEl = document.getElementById('volumeDisplay');
            volumeEl.textContent = (volume / 1000000).toFixed(1) + 'M';
            
            // Animate volume bar
            const volumeBar = document.getElementById('volumeBar');
            const intensity = Math.min(volume / 50000000, 1); // Normalize to 0-1
            volumeBar.style.width = (intensity * 100) + '%';
        }

        // Ticker input handler
        document.getElementById('customTicker').addEventListener('input', function() {
            const ticker = this.value.toUpperCase().trim();
            if (ticker) {
                currentTicker = ticker;
                updateChart();
                addLog(`🎯 Ticker changed to: ${ticker}`, 'info');
            }
        });

        // Initialize with first log entry
        addLog('🚀 Enhanced Fynda Auto Trading BOT ready', 'success');
    </script>
</body>
</html>
